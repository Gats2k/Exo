{% extends 'base.html' %}

{% block content %}
<div class="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-title">Môjo Admin</div>
        <div class="sidebar-subtitle">Tableau de bord</div>
    </div>

    <div class="sidebar-section">
        <a href="#" class="nav-item" data-section="dashboard">
            <i class="bi bi-speedometer2"></i>
            Tableau de bord
        </a>
        <a href="#" class="nav-item" data-section="users">
            <i class="bi bi-people"></i>
            Utilisateurs
        </a>
        <a href="#" class="nav-item" data-section="conversations">
            <i class="bi bi-chat-dots"></i>
            Conversations
        </a>
        <a href="#" class="nav-item" data-section="subscriptions">
            <i class="bi bi-credit-card"></i>
            Abonnements
        </a>
        <a href="#" class="nav-item" data-section="settings">
            <i class="bi bi-gear"></i>
            Paramètres
        </a>
    </div>

    <div class="sidebar-section">
        <div class="admin-profile">
            <div class="admin-avatar">A</div>
            <div class="admin-info">
                <div class="admin-name">Admin</div>
                <div class="admin-email">admin@mojo.edu</div>
            </div>
        </div>
    </div>
</div>

<div class="main-content">
    <div class="top-nav">
        <div class="web-selector-container">
            <div class="web-selector" onclick="toggleDropdown()">
                <i class="bi bi-globe" id="platform-icon"></i>
                <span id="selected-platform">Web</span>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="web-selector-dropdown" id="platformDropdown">
                <div class="web-selector-option active" onclick="selectPlatform('web')">
                    <i class="bi bi-globe"></i>
                    Web
                </div>
                <div class="web-selector-option" onclick="selectPlatform('telegram')">
                    <i class="bi bi-telegram"></i>
                    Telegram
                </div>
                <div class="web-selector-option" onclick="selectPlatform('whatsapp')">
                    <i class="bi bi-whatsapp"></i>
                    WhatsApp
                </div>
            </div>
        </div>
        <div class="notification-bell">
            <i class="bi bi-bell"></i>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Section -->
        <div class="section" id="dashboard-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-title">Utilisateurs</div>
                        <i class="bi bi-people stat-icon"></i>
                    </div>
                    <div class="stat-value">{{ active_users }}</div>
                    <div class="stat-subtitle">+{{ active_users_today }} aujourd'hui</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-title">Conversations</div>
                        <i class="bi bi-chat-dots stat-icon"></i>
                    </div>
                    <div class="stat-value">{{ today_conversations }}</div>
                    <div class="stat-subtitle neutral">Aujourd'hui</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-title">Satisfaction</div>
                        <i class="bi bi-graph-up stat-icon"></i>
                    </div>
                    <div class="stat-value">{{ satisfaction_rate }}%</div>
                    <div class="stat-subtitle">Positive</div>
                </div>
            </div>

            <h2 class="section-title">Liste des utilisateurs</h2>
            <div class="table-container" id="usersTableContainer">
                <div class="empty-state" style="display: none;">
                    <i class="bi bi-people"></i>
                    <p>Aucun utilisateur disponible pour le moment</p>
                </div>
                <table class="data-table" id="usersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nom</th>
                            <th>Prénom</th>
                            <th>Âge</th>
                            <th>Téléphone</th>
                            <th>Niveau d'étude</th>
                            <th>Date d'inscription</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <h2 class="section-title">Conversations récentes</h2>
            <div class="table-container" id="conversationsTableContainer">
                <div class="empty-state" style="display: none;">
                    <i class="bi bi-chat-dots"></i>
                    <p>Aucune conversation disponible pour le moment</p>
                </div>
                <table class="data-table" id="conversationsTable">
                    <thead>
                        <tr>
                            <th>Titre</th>
                            <th>Date</th>
                            <th>Heure</th>
                            <th>Dernier message</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Users Section -->
        <div class="section" id="users-section" style="display: none;">
            <h1 class="section-title">Tous les Utilisateurs</h1>
            <div class="users-filters">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Rechercher un utilisateur..." id="userSearchInput">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Tous</button>
                    <button class="filter-btn" data-filter="active">Actifs</button>
                    <button class="filter-btn" data-filter="inactive">Inactifs</button>
                </div>
            </div>
            <div class="table-container" id="fullUsersTableContainer">
                <div class="empty-state" style="display: none;">
                    <i class="bi bi-people"></i>
                    <p>Aucun utilisateur disponible pour le moment</p>
                </div>
                <table class="data-table" id="fullUsersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nom</th>
                            <th>Prénom</th>
                            <th>Âge</th>
                            <th>Téléphone</th>
                            <th>Niveau d'étude</th>
                            <th>Date d'inscription</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Conversations Section -->
        <div class="section" id="conversations-section" style="display: none;">
            <h1 class="section-title">Toutes les Conversations</h1>
            <div class="conversations-filters">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Rechercher une conversation..." id="conversationSearchInput">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Toutes</button>
                    <button class="filter-btn" data-filter="active">Actives</button>
                    <button class="filter-btn" data-filter="archived">Archivées</button>
                </div>
            </div>
            <div class="table-container" id="fullConversationsTableContainer">
                <div class="empty-state" style="display: none;">
                    <i class="bi bi-chat-dots"></i>
                    <p>Aucune conversation disponible pour le moment</p>
                </div>
                <table class="data-table" id="fullConversationsTable">
                    <thead>
                        <tr>
                            <th>Titre</th>
                            <th>Plateforme</th>
                            <th>Date</th>
                            <th>Dernier message</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Subscriptions Section -->
        <div class="section" id="subscriptions-section" style="display: none;">
            <h1 class="section-title">Gestion des Abonnements</h1>
            <div class="subscriptions-filters">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Rechercher un abonnement..." id="subscriptionSearchInput">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Tous</button>
                    <button class="filter-btn" data-filter="active">Actifs</button>
                    <button class="filter-btn" data-filter="expired">Expirés</button>
                </div>
            </div>
            <div class="table-container" id="subscriptionsTableContainer">
                <div class="empty-state" style="display: none;">
                    <i class="bi bi-credit-card"></i>
                    <p>Aucun abonnement disponible pour le moment</p>
                </div>
                <table class="data-table" id="subscriptionsTable">
                    <thead>
                        <tr>
                            <th>Utilisateur</th>
                            <th>Type</th>
                            <th>Date de début</th>
                            <th>Date d'expiration</th>
                            <th>Statut</th>
                            <th>Dernier paiement</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Modal de confirmation de suppression -->
        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Confirmation de suppression</h2>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer cet utilisateur ?</p>
                    <p class="warning-text">Cette action est définitive et ne pourra pas être annulée.</p>
                </div>
                <div class="modal-footer">
                    <button id="cancelDelete" class="modal-btn cancel">Annuler</button>
                    <button id="confirmDelete" class="modal-btn delete">Supprimer</button>
                </div>
            </div>
        </div>

        <!-- Add this modal for conversation deletion -->
        <div id="deleteConversationModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Confirmation de suppression</h2>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer cette conversation ?</p>
                    <p class="warning-text">Cette action est définitive et ne pourra pas être annulée.</p>
                </div>
                <div class="modal-footer">
                    <button id="cancelDeleteConversation" class="modal-btn cancel">Annuler</button>
                    <button id="confirmDeleteConversation" class="modal-btn delete">Supprimer</button>
                </div>
            </div>
        </div>

        <!-- Add this modal for conversation viewing after the other modals -->
        <div id="viewConversationModal" class="modal">
            <div class="modal-content conversation-modal">
                <span class="close-modal">&times;</span>
                <div class="modal-body chat-container">
                    <div class="chat-viewport">
                        <div class="chat-messages">
                            <!-- Messages will be loaded here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add subscription management modal -->
        <div id="subscriptionModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Gérer l'abonnement</h2>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="subscriptionForm">
                        <div class="form-group">
                            <label>Type d'abonnement</label>
                            <select name="subscription_type" required>
                                <option value="monthly">Mensuel</option>
                                <option value="quarterly">Trimestriel</option>
                                <option value="yearly">Annuel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date d'expiration</label>
                            <input type="date" name="expiry_date" required>
                        </div>
                        <div class="form-group">
                            <label>Statut</label>
                            <select name="status" required>
                                <option value="active">Actif</option>
                                <option value="pending">En attente</option>
                                <option value="expired">Expiré</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="cancelSubscriptionEdit" class="modal-btn cancel">Annuler</button>
                    <button id="saveSubscription" class="modal-btn save">Enregistrer</button>
                </div>
            </div>
        </div>


        <!-- Settings Section -->
        <div class="section" id="settings-section" style="display: none;">
            <h1 class="section-title">Configuration du Modèle IA</h1>
            <p class="section-description">Sélectionnez et configurez le modèle d'intelligence artificielle utilisé par le chatbot.</p>

            <!-- AI Model Configuration -->
            <div class="ai-config-card">

                <div class="ai-config-content">
                    <div class="model-selector">
                        <label for="ai-model">Modèle actuel</label>
                        <select id="ai-model" class="ai-config-select">
                            <option value="openai" selected>OpenAI (GPT)</option>
                            <option value="other" disabled>Autres modèles (Bientôt disponible)</option>
                        </select>
                    </div>

                    <!-- OpenAI Settings -->
                    <div id="openai-settings" class="model-settings">
                        <div class="ai-config-group">
                            <label>Assistant ID</label>
                            <input type="text" id="openai-assistant-id" class="ai-config-input" 
                                   value="{{ openai_assistant_id }}" readonly>
                            <p class="ai-config-help">L'ID de l'assistant OpenAI utilisé pour le chat.</p>
                        </div>

                        <div class="ai-config-group">
                            <label>Statut de l'API</label>
                            <div class="api-status">
                                <span class="status-indicator active"></span>
                                <span class="status-text">Connecté</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ai-config-footer">
                    <button id="save-ai-settings" class="ai-config-button">
                        <i class="bi bi-check2"></i>
                        Sauvegarder les modifications
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin_dashboard.js') }}"></script>
{% endblock %}