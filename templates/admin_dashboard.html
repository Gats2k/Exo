{% extends 'base.html' %}

{% block content %}
<div class="sidebar">
    <div class="sidebar-content">
        <div class="sidebar-section">
            <a href="#" class="nav-item" data-section="dashboard">
                <i class="bi bi-speedometer2"></i>
                <span>Tableau de bord</span>
            </a>
            <a href="#" class="nav-item" data-section="users">
                <i class="bi bi-people"></i>
                <span>Utilisateurs</span>
            </a>
            <a href="#" class="nav-item" data-section="conversations">
                <i class="bi bi-chat-dots"></i>
                <span>Conversations</span>
            </a>
            <a href="#" class="nav-item" data-section="subscriptions">
                <i class="bi bi-credit-card"></i>
                <span>Abonnements</span>
            </a>
            <a href="#" class="nav-item" data-section="settings">
                <i class="bi bi-gear"></i>
                <span>Paramètres</span>
            </a>
        </div>
    </div>

    <div class="sidebar-footer">
        <div class="admin-profile">
            <div class="admin-avatar">A</div>
            <div class="admin-info">
                <div class="admin-name">Admin</div>
                <div class="admin-email">admin@exo.edu</div>
            </div>
        </div>
    </div>
</div>

<div class="main-content">
    <div class="top-nav">
        <div class="top-nav-title">
            <button class="mobile-toggle" onclick="toggleMobileSidebar()">
                <i class="bi bi-mortarboard"></i>
                <i class="bi bi-mortarboard-fill"></i>
            </button>
            <div>
                <div class="sidebar-title">Exô Admin</div>
                <div class="sidebar-subtitle">Tableau de bord</div>
            </div>
        </div>
        <div style="margin-left: auto;"></div>

        <!-- Système de notification -->
        <div class="notification-container">
            <div class="notification-bell" onclick="toggleNotifications()">
                <i class="bi bi-bell"></i>
                <span class="notification-badge" id="notification-badge"></span>
            </div>
            <div class="notification-dropdown" id="notificationDropdown">
                <div class="notification-header">
                    <span>Notifications</span>
                    <button class="clear-all-btn" onclick="clearAllNotifications()">Tout effacer</button>
                </div>
                <div class="notification-list" id="notification-list">
                    <div class="empty-notifications" id="empty-notifications">
                        Aucune notification
                    </div>
                </div>
            </div>
        </div>

        <div class="web-selector-container">
            <div class="web-selector" onclick="toggleDropdown()">
                <i class="bi bi-globe" id="platform-icon"></i>
                <span id="selected-platform">Web</span>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="web-selector-dropdown" id="platformDropdown">
                <div class="web-selector-option active" onclick="selectPlatform('web')">
                    <i class="bi bi-globe"></i>
                    Web
                </div>
                <div class="web-selector-option" onclick="selectPlatform('telegram')">
                    <i class="bi bi-telegram"></i>
                    Telegram
                </div>
                <div class="web-selector-option" onclick="selectPlatform('whatsapp')">
                    <i class="bi bi-whatsapp"></i>
                    WhatsApp
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Section -->
        <div class="section" id="dashboard-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-title">Utilisateurs</div>
                        <i class="bi bi-people stat-icon"></i>
                    </div>
                    <div class="stat-value">{{ active_users }}</div>
                    <div class="stat-subtitle">+{{ active_users_today }} aujourd'hui</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-title">Conversations</div>
                        <i class="bi bi-chat-dots stat-icon"></i>
                    </div>
                    <div class="stat-value">{{ today_conversations }}</div>
                    <div class="stat-subtitle neutral">Aujourd'hui</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-title">Satisfaction</div>
                        <i class="bi bi-graph-up stat-icon"></i>
                    </div>
                    <div class="stat-value">{{ satisfaction_rate }}%</div>
                    <div class="stat-subtitle">Positive</div>
                </div>
            </div>

            <h2 class="section-title">Liste des utilisateurs</h2>
            <div class="table-container" id="usersTableContainer">
                <div class="empty-state" style="display: none;">
                    <i class="bi bi-people"></i>
                    <p>Aucun utilisateur disponible pour le moment</p>
                </div>
                <table class="data-table" id="usersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nom</th>
                            <th>Prénom</th>
                            <th>Âge</th>
                            <th>Téléphone</th>
                            <th>Niveau d'étude</th>
                            <th>Date d'inscription</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <h2 class="section-title">Conversations récentes</h2>
            <div class="table-container" id="conversationsTableContainer">
                <div class="empty-state" style="display: none;">
                    <i class="bi bi-chat-dots"></i>
                    <p>Aucune conversation disponible pour le moment</p>
                </div>
                <table class="data-table" id="conversationsTable">
                    <thead>
                        <tr>
                            <th>Titre</th>
                            <th>Date</th>
                            <th>Heure</th>
                            <th>Dernier message</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Users Section -->
        <div class="section" id="users-section" style="display: none;">
            <h1 class="section-title">Tous les Utilisateurs</h1>
            <div class="users-filters">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Rechercher un utilisateur..." id="userSearchInput">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Tous</button>
                    <button class="filter-btn" data-filter="active">Actifs</button>
                    <button class="filter-btn" data-filter="inactive">Inactifs</button>
                </div>
            </div>
            <div class="table-container" id="fullUsersTableContainer">
                <div class="empty-state" style="display: none;">
                    <i class="bi bi-people"></i>
                    <p>Aucun utilisateur disponible pour le moment</p>
                </div>
                <table class="data-table" id="fullUsersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nom</th>
                            <th>Prénom</th>
                            <th>Âge</th>
                            <th>Téléphone</th>
                            <th>Niveau d'étude</th>
                            <th>Date d'inscription</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="pagination-controls" id="userPaginationControls" style="display: none; text-align: center; margin-top: 15px;">
                <button id="userPrevPage" class="pagination-btn" disabled>&lt; Précédent</button>
                <span id="userPageInfo" style="margin: 0 10px;">Page 1 / 1</span>
                <button id="userNextPage" class="pagination-btn" disabled>Suivant &gt;</button>
            </div>
        </div>

        <!-- Conversations Section -->
        <div class="section" id="conversations-section" style="display: none;">
            <h1 class="section-title">Toutes les Conversations</h1>
            <div class="conversations-filters">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Rechercher une conversation..." id="conversationSearchInput">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Toutes</button>
                    <button class="filter-btn" data-filter="active">Actives</button>
                    <button class="filter-btn" data-filter="archived">Archivées</button>
                </div>
            </div>
            <div class="table-container" id="fullConversationsTableContainer">
                <div class="empty-state" style="display: none;">
                    <i class="bi bi-chat-dots"></i>
                    <p>Aucune conversation disponible pour le moment</p>
                </div>
                <table class="data-table" id="fullConversationsTable">
                    <thead>
                        <tr>
                            <th>Titre</th>
                            <th>Plateforme</th>
                            <th>Date</th>
                            <th>Dernier message</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="pagination-controls" id="conversationPaginationControls" style="display: none; text-align: center; margin-top: 15px;">
                <button id="convPrevPage" class="pagination-btn" disabled>&lt; Précédent</button>
                <span id="convPageInfo" style="margin: 0 10px;">Page 1 / 1</span>
                <button id="convNextPage" class="pagination-btn" disabled>Suivant &gt;</button>
            </div>
        </div>

        <!-- Subscriptions Section -->
        <div class="section" id="subscriptions-section" style="display: none;">
            <h1 class="section-title">Gestion des Abonnements</h1>
            <div class="subscriptions-filters">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Rechercher un abonnement..." id="subscriptionSearchInput">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Tous</button>
                    <button class="filter-btn" data-filter="active">Actifs</button>
                    <button class="filter-btn" data-filter="expired">Expirés</button>
                </div>
            </div>
            <div class="table-container" id="subscriptionsTableContainer">
                <div class="empty-state" style="display: none;">
                    <i class="bi bi-credit-card"></i>
                    <p>Aucun abonnement disponible pour le moment</p>
                </div>
                <table class="data-table" id="subscriptionsTable">
                    <thead>
                        <tr>
                            <th>Utilisateur</th>
                            <th>Type</th>
                            <th>Date de début</th>
                            <th>Date d'expiration</th>
                            <th>Statut</th>
                            <th>Dernier paiement</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Modal de confirmation de suppression -->
        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Confirmation de suppression</h2>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer cet utilisateur ?</p>
                    <p class="warning-text">Cette action est définitive et ne pourra pas être annulée.</p>
                </div>
                <div class="modal-footer">
                    <button id="cancelDelete" class="modal-btn cancel">Annuler</button>
                    <button id="confirmDelete" class="modal-btn delete">Supprimer</button>
                </div>
            </div>
        </div>

        <!-- Add this modal for conversation deletion -->
        <div id="deleteConversationModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Confirmation de suppression</h2>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer cette conversation ?</p>
                    <p class="warning-text">Cette action est définitive et ne pourra pas être annulée.</p>
                </div>
                <div class="modal-footer">
                    <button id="cancelDeleteConversation" class="modal-btn cancel">Annuler</button>
                    <button id="confirmDeleteConversation" class="modal-btn delete">Supprimer</button>
                </div>
            </div>
        </div>

        <!-- Add this modal for conversation viewing after the other modals -->
        <div id="viewConversationModal" class="modal">
            <div class="modal-content conversation-modal">
                <span class="close-modal">&times;</span>
                <div class="modal-body chat-container">
                    <div class="chat-viewport">
                        <div class="chat-messages">
                            <!-- Messages will be loaded here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add subscription management modal -->
        <div id="subscriptionModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Gérer l'abonnement</h2>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="subscriptionForm">
                        <div class="form-group">
                            <label>Type d'abonnement</label>
                            <select name="subscription_type" required>
                                <option value="monthly">Mensuel</option>
                                <option value="quarterly">Trimestriel</option>
                                <option value="yearly">Annuel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date d'expiration</label>
                            <input type="date" name="expiry_date" required>
                        </div>
                        <div class="form-group">
                            <label>Statut</label>
                            <select name="status" required>
                                <option value="active">Actif</option>
                                <option value="pending">En attente</option>
                                <option value="expired">Expiré</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="cancelSubscriptionEdit" class="modal-btn cancel">Annuler</button>
                    <button id="saveSubscription" class="modal-btn save">Enregistrer</button>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section" id="settings-section" style="display: none;">
            <h1 class="section-title">Configuration du Modèle IA</h1>
            <p class="section-description">Sélectionnez et configurez le modèle d'intelligence artificielle utilisé par le chatbot.</p>

            <!-- AI Model Configuration -->
            <div class="ai-config-card">

                <div class="ai-config-content">
                    <div class="model-selector">
                        <label for="ai-model">Modèle actuel</label>
                        <select id="ai-model" class="ai-config-select">
                            <option value="openai" {% if current_model == 'openai' %}selected{% endif %}>OpenAI (GPT)</option>
                            <option value="deepseek" {% if current_model == 'deepseek' %}selected{% endif %}>DeepSeek Chat</option>
                            <option value="deepseek-reasoner" {% if current_model == 'deepseek-reasoner' %}selected{% endif %}>DeepSeek Reasoner</option>
                            <option value="qwen" {% if current_model == 'qwen' %}selected{% endif %}>Qwen Max</option>
                            <option value="gemini" {% if current_model == 'gemini' %}selected{% endif %}>Google Gemini 2.5 Flash</option>
                            <option value="other" disabled>Autres modèles (Bientôt disponible)</option>
                        </select>
                    </div>

                    <!-- OpenAI Settings -->
                    <div id="openai-settings" class="model-settings" {% if current_model != 'openai' %}style="display: none;"{% endif %}>
                        <div class="ai-config-group">
                            <label>Assistant ID</label>
                            <input type="text" id="openai-assistant-id" class="ai-config-input" 
                                   value="{{ openai_assistant_id }}" readonly>
                            <p class="ai-config-help">L'ID de l'assistant OpenAI utilisé pour le chat.</p>
                        </div>

                        <div class="ai-config-group">
                            <label>Statut de l'API</label>
                            <div class="api-status">
                                <span class="status-indicator active"></span>
                                <span class="status-text">Connecté</span>
                            </div>
                        </div>
                    </div>

                    <!-- DeepSeek Settings -->
                    <div id="deepseek-settings" class="model-settings" {% if current_model != 'deepseek' %}style="display: none;"{% endif %}>
                        <div class="ai-config-group">
                            <label>Modèle</label>
                            <input type="text" class="ai-config-input" value="deepseek-chat" readonly>
                            <p class="ai-config-help">Le modèle DeepSeek utilisé pour le chat.</p>
                        </div>

                        <div class="ai-config-group">
                            <label>Instructions personnalisées</label>
                            <textarea id="deepseek-instructions" class="ai-config-input" rows="4" 
                                      placeholder="Entrez des instructions personnalisées pour le modèle...">{{ deepseek_instructions }}</textarea>
                            <p class="ai-config-help">Ces instructions seront utilisées comme contexte système pour guider les réponses du modèle.</p>
                        </div>

                        <div class="ai-config-group">
                            <label>Statut de l'API</label>
                            <div class="api-status">
                                <span class="status-indicator active"></span>
                                <span class="status-text">Connecté</span>
                            </div>
                        </div>
                    </div>

                    <!-- DeepSeek Reasoner Settings -->
                    <div id="deepseek-reasoner-settings" class="model-settings" {% if current_model != 'deepseek-reasoner' %}style="display: none;"{% endif %}>
                        <div class="ai-config-group">
                            <label>Modèle</label>
                            <input type="text" class="ai-config-input" value="deepseek-reasoner" readonly>
                            <p class="ai-config-help">Le modèle DeepSeek Reasoner, optimisé pour le raisonnement.</p>
                        </div>

                        <div class="ai-config-group">
                            <label>Instructions personnalisées</label>
                            <textarea id="deepseek-reasoner-instructions" class="ai-config-input" rows="4" 
                                      placeholder="Entrez des instructions personnalisées pour le modèle...">{{ deepseek_reasoner_instructions }}</textarea>
                            <p class="ai-config-help">Ces instructions seront utilisées comme contexte système pour guider les réponses du modèle.</p>
                        </div>

                        <div class="ai-config-group">
                            <label>Statut de l'API</label>
                            <div class="api-status">
                                <span class="status-indicator active"></span>
                                <span class="status-text">Connecté</span>
                            </div>
                        </div>
                    </div>

                    <!-- Qwen Max Settings -->
                    <div id="qwen-settings" class="model-settings" {% if current_model != 'qwen' %}style="display: none;"{% endif %}>
                        <div class="ai-config-group">
                            <label>Modèle</label>
                            <input type="text" class="ai-config-input" value="qwen-max-latest" readonly>
                            <p class="ai-config-help">Le modèle Qwen Max d'Alibaba Cloud, offrant des performances avancées.</p>
                        </div>

                        <div class="ai-config-group">
                            <label>Instructions personnalisées</label>
                            <textarea id="qwen-instructions" class="ai-config-input" rows="4" 
                                    placeholder="Entrez des instructions personnalisées pour le modèle...">{{ qwen_instructions }}</textarea>
                            <p class="ai-config-help">Ces instructions seront utilisées comme contexte système pour guider les réponses du modèle.</p>
                        </div>

                        <div class="ai-config-group">
                            <label>Statut de l'API</label>
                            <div class="api-status">
                                <span class="status-indicator active"></span>
                                <span class="status-text">Connecté</span>
                            </div>
                        </div>
                    </div>

                    <!-- Gemini Settings -->
                    <div id="gemini-settings" class="model-settings" {% if current_model != 'gemini' %}style="display: none;"{% endif %}>
                        <div class="ai-config-group">
                            <label>Modèle</label>
                            <input type="text" class="ai-config-input" value="gemini-2.5-flash-preview-04-17" readonly>
                            <p class="ai-config-help">Le modèle Gemini 2.0 Flash de Google, rapide et efficace.</p>
                        </div>

                        <div class="ai-config-group">
                            <label>Instructions personnalisées</label>
                            <textarea id="gemini-instructions" class="ai-config-input" rows="4" 
                                    placeholder="Entrez des instructions personnalisées pour le modèle...">{{ gemini_instructions }}</textarea>
                            <p class="ai-config-help">Ces instructions seront utilisées comme contexte système pour guider les réponses du modèle.</p>
                        </div>

                        <div class="ai-config-group">
                            <label>Statut de l'API</label>
                            <div class="api-status">
                                <span class="status-indicator active"></span>
                                <span class="status-text">Connecté</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ai-config-footer">
                    <button id="save-ai-settings" class="ai-config-button">
                        <i class="bi bi-check2"></i>
                        Sauvegarder les modifications
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="{{ url_for('static', filename='js/admin_dashboard.js') }}"></script>
<script>
    // Notification d'événements en temps réel
    const notificationEventMessages = {
        feedback_stats_updated: "Les statistiques de satisfaction ont été mises à jour"
    };
</script>
{% endblock %}